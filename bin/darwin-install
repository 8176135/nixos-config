#!/bin/sh -e

VERSION=1.0

GREEN='\033[1;32m'
RED='\033[1;31m'
CLEAR='\033[0m'

FLAKE="Dustins-MBP"
SYSTEM="darwinConfigurations.$FLAKE.system"

export NIXPKGS_ALLOW_UNFREE=1
echo "${GREEN}Enabling access for homebrew${CLEAR}"
sudo chown -R root:staff /opt/homebrew/Library/Taps/homebrew
sudo chmod -R g+w /opt/homebrew/Library/Taps/homebrew

echo "${GREEN}Preparing to install${CLEAR}"
sudo mv /etc/nix/nix.conf /etc/nix/nix.conf.before-nix-darwin

# Navigate to the directory of this script
cd $(dirname $(readlink -f $0))
cd ..

echo "${GREEN}Starting...${CLEAR}"
# --impure is needed for <home-manager/nix-darwin> channel
nix --experimental-features 'nix-command flakes' build .#$SYSTEM --impure $@

echo "${GREEN}Switching to new generation...${CLEAR}"
# --impure is needed for <home-manager/nix-darwin> channel
./result/sw/bin/darwin-rebuild switch --flake .#$FLAKE --impure $@

echo "${GREEN}Cleaning up...${CLEAR}"
unlink ./result

echo "${GREEN}Done${CLEAR}"
