name: Test Nix Flake

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  nix-flake-build:
    runs-on: ubuntu-latest
    name: Build Nix Flake
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Nix
      uses: cachix/install-nix-action@v13

    # Initialize a new Nix flake
    - name: Initialize Nix Flake
      run: |
        mkdir -p my-config && cd my-config
        nix flake --extra-experimental-features 'nix-command flakes' init -t github:dustinlyons/nixos-config#starter

    # Apply CI user info
    - name: Apply CI User Info
      run: |
        cd /home/runner/work/nixos-config/nixos-config/my-config
        /home/runner/work/nixos-config/nixos-config/bin/apply-ci

    # Build the Nix Flake
    - name: Build Nix Flake
      run: |
        cd /home/runner/work/nixos-config/nixos-config/my-config
        git add .
        nix build --extra-experimental-features 'nix-command flakes' /home/runner/work/nixos-config/nixos-config/my-config#nixosConfigurations.x86_64-linux.system
